# 机器学习教学平台 - 技术架构设计

## 🏗️ 系统架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                         用户端                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Web浏览器   │  │   移动浏览器  │  │  平板浏览器   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└───────────────────────────┬─────────────────────────────────┘
                            │ HTTPS
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                         CDN层                                │
│              (静态资源、图片、视频加速)                        │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    负载均衡器 (Nginx)                         │
└────────────┬──────────────────────────────┬─────────────────┘
             │                              │
             ↓                              ↓
┌────────────────────────┐      ┌────────────────────────┐
│     前端服务器集群      │      │    API网关              │
│    (Next.js SSR)       │      │    (Express)           │
│  ┌──────────────────┐  │      │  ┌──────────────────┐  │
│  │  服务器 #1       │  │      │  │  认证中间件       │  │
│  │  服务器 #2       │  │      │  │  限流中间件       │  │
│  │  服务器 #3       │  │      │  │  日志中间件       │  │
│  └──────────────────┘  │      │  └──────────────────┘  │
└────────────────────────┘      └────────────┬───────────┘
                                             │
                     ┌───────────────────────┼───────────────────────┐
                     │                       │                       │
                     ↓                       ↓                       ↓
         ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐
         │   课程服务          │  │   代码执行服务      │  │   用户服务          │
         │   (Node.js)        │  │   (Python+Docker)  │  │   (Node.js)        │
         └─────────┬──────────┘  └─────────┬──────────┘  └─────────┬──────────┘
                   │                       │                       │
                   └───────────────────────┼───────────────────────┘
                                           │
                   ┌───────────────────────┼───────────────────────┐
                   │                       │                       │
                   ↓                       ↓                       ↓
         ┌────────────────┐    ┌────────────────┐      ┌────────────────┐
         │   PostgreSQL   │    │     Redis      │      │   S3/OSS       │
         │   (主数据库)    │    │   (缓存/会话)   │      │  (文件存储)     │
         └────────────────┘    └────────────────┘      └────────────────┘
```

---

## 📦 前端架构

### 技术选型

#### 核心框架
- **Next.js 14+**: React SSR框架
  - App Router (新路由系统)
  - Server Components
  - API Routes
  - 自动代码分割

#### 状态管理
- **Zustand**: 全局状态
  ```typescript
  // 轻量级状态管理示例
  import create from 'zustand'
  
  interface UserStore {
    user: User | null
    login: (user: User) => void
    logout: () => void
  }
  
  export const useUserStore = create<UserStore>((set) => ({
    user: null,
    login: (user) => set({ user }),
    logout: () => set({ user: null })
  }))
  ```

- **React Query**: 服务端状态
  ```typescript
  // 数据获取和缓存
  const { data, isLoading } = useQuery({
    queryKey: ['courses'],
    queryFn: fetchCourses,
    staleTime: 5 * 60 * 1000 // 5分钟
  })
  ```

#### UI组件库
- **Radix UI**: 无样式组件（可访问性好）
- **Tailwind CSS**: 样式系统
- **Framer Motion**: 动画库

#### 可视化库
- **D3.js**: 自定义复杂可视化
- **Plotly.js**: 科学图表
- **Recharts**: React图表组件

### 目录结构

```
frontend/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── (auth)/            # 认证相关页面（路由组）
│   │   │   ├── login/
│   │   │   └── register/
│   │   ├── (dashboard)/       # 主应用页面
│   │   │   ├── courses/       # 课程页面
│   │   │   ├── playground/    # 代码实验室
│   │   │   ├── practice/      # 练习系统
│   │   │   └── projects/      # 项目实战
│   │   ├── api/               # API Routes
│   │   ├── layout.tsx         # 根布局
│   │   └── page.tsx           # 首页
│   │
│   ├── components/            # 组件
│   │   ├── ui/               # 基础UI组件
│   │   │   ├── Button.tsx
│   │   │   ├── Card.tsx
│   │   │   ├── Input.tsx
│   │   │   └── Modal.tsx
│   │   ├── visualizations/   # 可视化组件
│   │   │   ├── LinearRegression.tsx
│   │   │   ├── KMeans.tsx
│   │   │   ├── NeuralNetwork.tsx
│   │   │   └── DecisionTree.tsx
│   │   ├── editor/           # 代码编辑器
│   │   │   ├── CodeEditor.tsx
│   │   │   ├── OutputPanel.tsx
│   │   │   └── CodeSnippets.tsx
│   │   └── course/           # 课程相关组件
│   │       ├── LessonViewer.tsx
│   │       ├── ProgressBar.tsx
│   │       └── TableOfContents.tsx
│   │
│   ├── hooks/                # 自定义Hooks
│   │   ├── useAuth.ts
│   │   ├── useCourse.ts
│   │   ├── useCodeExecution.ts
│   │   └── useProgress.ts
│   │
│   ├── lib/                  # 工具库
│   │   ├── api.ts           # API客户端
│   │   ├── auth.ts          # 认证工具
│   │   └── utils.ts         # 通用工具
│   │
│   ├── stores/              # 状态管理
│   │   ├── userStore.ts
│   │   ├── courseStore.ts
│   │   └── editorStore.ts
│   │
│   ├── types/               # TypeScript类型定义
│   │   ├── user.ts
│   │   ├── course.ts
│   │   └── api.ts
│   │
│   └── styles/              # 全局样式
│       ├── globals.css
│       └── tailwind.css
│
├── public/                  # 静态资源
│   ├── images/
│   ├── icons/
│   └── fonts/
│
├── tests/                   # 测试文件
│   ├── unit/
│   ├── integration/
│   └── e2e/
│
├── next.config.js
├── tailwind.config.js
├── tsconfig.json
└── package.json
```

### 核心组件设计

#### 1. 可视化组件接口

```typescript
// components/visualizations/types.ts
export interface VisualizationProps {
  // 通用配置
  width?: number
  height?: number
  theme?: 'light' | 'dark'
  
  // 控制选项
  autoPlay?: boolean
  speed?: number
  showControls?: boolean
  
  // 回调函数
  onComplete?: () => void
  onPause?: () => void
  onParameterChange?: (params: any) => void
}

// components/visualizations/LinearRegression.tsx
export const LinearRegression: React.FC<VisualizationProps> = ({
  width = 800,
  height = 600,
  autoPlay = false,
  speed = 1,
  showControls = true
}) => {
  const [isPlaying, setIsPlaying] = useState(autoPlay)
  const [learningRate, setLearningRate] = useState(0.01)
  const [iterations, setIterations] = useState(100)
  
  // D3.js绘图逻辑
  useEffect(() => {
    // 初始化SVG
    // 绘制数据点
    // 动画逻辑
  }, [isPlaying, learningRate, iterations])
  
  return (
    <div className="visualization-container">
      <svg ref={svgRef} width={width} height={height} />
      {showControls && (
        <ControlPanel
          isPlaying={isPlaying}
          onPlay={() => setIsPlaying(true)}
          onPause={() => setIsPlaying(false)}
          learningRate={learningRate}
          onLearningRateChange={setLearningRate}
        />
      )}
    </div>
  )
}
```

#### 2. 代码编辑器组件

```typescript
// components/editor/CodeEditor.tsx
import Editor from '@monaco-editor/react'

interface CodeEditorProps {
  initialCode?: string
  language?: string
  onCodeChange?: (code: string) => void
  onRun?: (code: string) => void
}

export const CodeEditor: React.FC<CodeEditorProps> = ({
  initialCode = '',
  language = 'python',
  onCodeChange,
  onRun
}) => {
  const [code, setCode] = useState(initialCode)
  const [isRunning, setIsRunning] = useState(false)
  
  const handleRun = async () => {
    setIsRunning(true)
    try {
      await onRun?.(code)
    } finally {
      setIsRunning(false)
    }
  }
  
  return (
    <div className="code-editor">
      <div className="toolbar">
        <button 
          onClick={handleRun}
          disabled={isRunning}
          className="btn-run"
        >
          {isRunning ? '运行中...' : '运行代码'}
        </button>
      </div>
      <Editor
        height="500px"
        language={language}
        value={code}
        onChange={(value) => {
          setCode(value || '')
          onCodeChange?.(value || '')
        }}
        theme="vs-dark"
        options={{
          minimap: { enabled: false },
          fontSize: 14,
          wordWrap: 'on',
          automaticLayout: true
        }}
      />
    </div>
  )
}
```

---

## 🔧 后端架构

### 服务分层

```
┌─────────────────────────────────────┐
│         API Gateway                 │
│  (路由、认证、限流、日志)              │
└────────────────┬────────────────────┘
                 │
     ┌───────────┼───────────┐
     │           │           │
     ↓           ↓           ↓
┌─────────┐ ┌─────────┐ ┌─────────┐
│课程服务  │ │用户服务  │ │执行服务  │
└────┬────┘ └────┬────┘ └────┬────┘
     │           │           │
     └───────────┼───────────┘
                 │
                 ↓
         ┌───────────────┐
         │   数据访问层   │
         └───────────────┘
```

### 目录结构

```
backend/
├── src/
│   ├── api/                   # API层
│   │   ├── routes/           # 路由定义
│   │   │   ├── auth.ts
│   │   │   ├── courses.ts
│   │   │   ├── users.ts
│   │   │   └── code-execution.ts
│   │   ├── middlewares/      # 中间件
│   │   │   ├── auth.ts
│   │   │   ├── validation.ts
│   │   │   ├── rateLimit.ts
│   │   │   └── errorHandler.ts
│   │   └── controllers/      # 控制器
│   │       ├── AuthController.ts
│   │       ├── CourseController.ts
│   │       └── UserController.ts
│   │
│   ├── services/             # 业务逻辑层
│   │   ├── AuthService.ts
│   │   ├── CourseService.ts
│   │   ├── UserService.ts
│   │   ├── CodeExecutionService.ts
│   │   └── ProgressService.ts
│   │
│   ├── models/               # 数据模型
│   │   ├── User.ts
│   │   ├── Course.ts
│   │   ├── Lesson.ts
│   │   ├── Progress.ts
│   │   └── Exercise.ts
│   │
│   ├── database/             # 数据库
│   │   ├── migrations/      # 迁移文件
│   │   ├── seeds/           # 种子数据
│   │   └── connection.ts    # 数据库连接
│   │
│   ├── utils/               # 工具函数
│   │   ├── jwt.ts
│   │   ├── bcrypt.ts
│   │   ├── logger.ts
│   │   └── validators.ts
│   │
│   └── config/              # 配置
│       ├── database.ts
│       ├── redis.ts
│       └── app.ts
│
├── tests/                   # 测试
│   ├── unit/
│   ├── integration/
│   └── fixtures/
│
├── docker/                  # Docker配置
│   ├── Dockerfile
│   └── docker-compose.yml
│
├── scripts/                 # 脚本
│   ├── migrate.ts
│   └── seed.ts
│
├── tsconfig.json
└── package.json
```

### 数据库设计

#### 核心表结构

```sql
-- 用户表
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  username VARCHAR(100) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  avatar_url VARCHAR(500),
  bio TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 课程表
CREATE TABLE courses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(255) NOT NULL,
  description TEXT,
  difficulty VARCHAR(20) CHECK (difficulty IN ('beginner', 'intermediate', 'advanced')),
  thumbnail_url VARCHAR(500),
  estimated_hours INTEGER,
  tags TEXT[],
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 课程章节表
CREATE TABLE lessons (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  course_id UUID REFERENCES courses(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  content TEXT NOT NULL,
  order_index INTEGER NOT NULL,
  lesson_type VARCHAR(50) CHECK (lesson_type IN ('theory', 'visualization', 'coding', 'quiz')),
  metadata JSONB,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 学习进度表
CREATE TABLE progress (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  lesson_id UUID REFERENCES lessons(id) ON DELETE CASCADE,
  status VARCHAR(20) CHECK (status IN ('not_started', 'in_progress', 'completed')),
  completion_percentage INTEGER DEFAULT 0,
  last_position INTEGER,
  completed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, lesson_id)
);

-- 练习题表
CREATE TABLE exercises (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  lesson_id UUID REFERENCES lessons(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  question TEXT NOT NULL,
  exercise_type VARCHAR(50) CHECK (exercise_type IN ('multiple_choice', 'coding', 'fill_blank')),
  difficulty VARCHAR(20) CHECK (difficulty IN ('easy', 'medium', 'hard')),
  test_cases JSONB,
  answer JSONB,
  explanation TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 用户答题记录表
CREATE TABLE exercise_submissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  exercise_id UUID REFERENCES exercises(id) ON DELETE CASCADE,
  answer JSONB NOT NULL,
  is_correct BOOLEAN,
  score INTEGER,
  submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 项目表
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(255) NOT NULL,
  description TEXT,
  difficulty VARCHAR(20),
  dataset_url VARCHAR(500),
  starter_code TEXT,
  solution_code TEXT,
  tags TEXT[],
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 用户项目提交表
CREATE TABLE project_submissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  code TEXT NOT NULL,
  result JSONB,
  score INTEGER,
  submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 成就表
CREATE TABLE achievements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  description TEXT,
  icon_url VARCHAR(500),
  criteria JSONB,
  points INTEGER DEFAULT 0
);

-- 用户成就表
CREATE TABLE user_achievements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  achievement_id UUID REFERENCES achievements(id) ON DELETE CASCADE,
  earned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, achievement_id)
);

-- 索引
CREATE INDEX idx_lessons_course_id ON lessons(course_id);
CREATE INDEX idx_progress_user_id ON progress(user_id);
CREATE INDEX idx_progress_lesson_id ON progress(lesson_id);
CREATE INDEX idx_exercises_lesson_id ON exercises(lesson_id);
CREATE INDEX idx_exercise_submissions_user_id ON exercise_submissions(user_id);
```

### API设计规范

#### 认证相关

```typescript
// POST /api/auth/register
{
  email: string
  username: string
  password: string
}
// Response: { user: User, token: string }

// POST /api/auth/login
{
  email: string
  password: string
}
// Response: { user: User, token: string, refreshToken: string }

// POST /api/auth/refresh
{
  refreshToken: string
}
// Response: { token: string }

// POST /api/auth/logout
// Response: { message: string }
```

#### 课程相关

```typescript
// GET /api/courses
// Query: { difficulty?, tags?, page?, limit? }
// Response: { courses: Course[], total: number, page: number }

// GET /api/courses/:id
// Response: { course: Course, lessons: Lesson[] }

// GET /api/courses/:id/lessons/:lessonId
// Response: { lesson: Lesson, nextLesson?: Lesson, prevLesson?: Lesson }

// POST /api/progress
{
  lessonId: string
  status: 'in_progress' | 'completed'
  completionPercentage: number
}
// Response: { progress: Progress }
```

#### 代码执行

```typescript
// POST /api/code/execute
{
  code: string
  language: 'python'
  timeLimit?: number  // 默认5秒
  memoryLimit?: number // 默认128MB
}
// Response: {
//   status: 'success' | 'error' | 'timeout'
//   output?: string
//   error?: string
//   executionTime?: number
// }
```

---

## 🐳 代码执行服务架构

### Docker容器方案

#### 执行流程

```
用户提交代码
     ↓
API Gateway (验证、限流)
     ↓
代码执行服务
     ↓
创建临时Docker容器
     ↓
执行代码（资源限制）
     ↓
收集输出/错误
     ↓
销毁容器
     ↓
返回结果
```

#### Docker配置

```dockerfile
# docker/python-sandbox/Dockerfile
FROM python:3.11-slim

# 安装必要的库
RUN pip install --no-cache-dir \
    numpy==1.24.0 \
    pandas==2.0.0 \
    scikit-learn==1.3.0 \
    matplotlib==3.7.0 \
    seaborn==0.12.0

# 创建非root用户
RUN useradd -m -u 1000 sandbox
USER sandbox

WORKDIR /app

# 资源限制在docker-compose中配置
CMD ["python"]
```

#### 执行服务代码

```typescript
// services/CodeExecutionService.ts
import Docker from 'dockerode'

const docker = new Docker()

export class CodeExecutionService {
  async executeCode(code: string, timeLimit = 5000, memoryLimit = 128 * 1024 * 1024) {
    const container = await docker.createContainer({
      Image: 'mllearning-python-sandbox',
      Cmd: ['python', '-c', code],
      HostConfig: {
        Memory: memoryLimit,
        CpuQuota: 50000, // 50% CPU
        NetworkMode: 'none', // 禁用网络
        AutoRemove: true
      },
      WorkingDir: '/app',
      User: 'sandbox'
    })

    try {
      await container.start()
      
      // 设置超时
      const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Execution timeout')), timeLimit)
      )
      
      const execPromise = container.wait()
      
      const result = await Promise.race([execPromise, timeoutPromise])
      
      // 获取输出
      const logs = await container.logs({
        stdout: true,
        stderr: true
      })
      
      return {
        status: 'success',
        output: logs.toString(),
        executionTime: result.StatusCode
      }
    } catch (error) {
      await container.stop()
      return {
        status: 'error',
        error: error.message
      }
    }
  }
}
```

### 安全措施

1. **资源限制**
   - CPU限制: 50%
   - 内存限制: 128MB
   - 执行时间: 5秒
   - 磁盘限制: 禁止写入

2. **网络隔离**
   - 禁用网络访问
   - 无法访问外部资源

3. **代码审查**
   - 黑名单检测（eval, exec, import os等）
   - 代码长度限制
   - AST静态分析

4. **容器隔离**
   - 每次执行独立容器
   - 执行后立即销毁
   - 非root用户执行

---

## 🔐 安全架构

### 认证流程

```
用户登录
   ↓
验证用户名密码
   ↓
生成JWT Token
   ├─ Access Token (15分钟有效)
   └─ Refresh Token (7天有效)
   ↓
返回Token给客户端
   ↓
客户端存储在内存 (Access Token)
和HttpOnly Cookie (Refresh Token)
   ↓
后续请求携带Access Token
   ↓
Token过期时使用Refresh Token刷新
```

### JWT Payload

```typescript
interface JWTPayload {
  userId: string
  email: string
  username: string
  role: 'user' | 'admin'
  iat: number  // 签发时间
  exp: number  // 过期时间
}
```

### 权限控制

```typescript
// middlewares/auth.ts
export const requireAuth = async (req, res, next) => {
  try {
    const token = req.headers.authorization?.split(' ')[1]
    
    if (!token) {
      return res.status(401).json({ error: 'No token provided' })
    }
    
    const decoded = jwt.verify(token, process.env.JWT_SECRET)
    req.user = decoded
    next()
  } catch (error) {
    return res.status(401).json({ error: 'Invalid token' })
  }
}

export const requireAdmin = (req, res, next) => {
  if (req.user.role !== 'admin') {
    return res.status(403).json({ error: 'Admin access required' })
  }
  next()
}
```

---

## 📊 监控和日志

### 监控指标

1. **应用性能监控 (APM)**
   - 接口响应时间
   - 错误率
   - 吞吐量

2. **基础设施监控**
   - CPU使用率
   - 内存使用率
   - 磁盘IO
   - 网络流量

3. **业务指标**
   - 用户注册数
   - 活跃用户数
   - 代码执行次数
   - 课程完成率

### 日志系统

```typescript
// utils/logger.ts
import winston from 'winston'

export const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' }),
    new winston.transports.Console({
      format: winston.format.simple()
    })
  ]
})

// 使用示例
logger.info('User logged in', { userId: '123', email: 'user@example.com' })
logger.error('Code execution failed', { error: error.message, code })
```

---

## 🚀 部署架构

### 生产环境

```
           ┌─────────────────┐
           │   Cloudflare    │
           │   (CDN + DNS)   │
           └────────┬────────┘
                    │
           ┌────────▼────────┐
           │   Nginx         │
           │ (Load Balancer) │
           └────────┬────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
   ┌────▼─────┐           ┌────▼─────┐
   │ Frontend │           │ Backend  │
   │ (Vercel) │           │ (AWS EC2)│
   └──────────┘           └────┬─────┘
                               │
                    ┌──────────┼──────────┐
                    │          │          │
              ┌─────▼────┐ ┌──▼───┐  ┌──▼──────┐
              │PostgreSQL│ │Redis │  │S3/OSS   │
              │   (RDS)  │ │      │  │(Storage)│
              └──────────┘ └──────┘  └─────────┘
```

### Docker Compose配置

```yaml
version: '3.8'

services:
  # API服务
  api:
    build: ./backend
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://user:pass@db:5432/mllearning
      - REDIS_URL=redis://redis:6379
    depends_on:
      - db
      - redis
    restart: always

  # 数据库
  db:
    image: postgres:15
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=mllearning
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    restart: always

  # Redis
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    restart: always

  # Nginx
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - api
    restart: always

volumes:
  postgres_data:
  redis_data:
```

---

## 📈 性能优化策略

### 前端优化

1. **代码分割**
   ```typescript
   // 路由级别的代码分割
   const CoursePage = dynamic(() => import('@/components/CoursePage'))
   
   // 组件级别的懒加载
   const Visualization = dynamic(
     () => import('@/components/visualizations/LinearRegression'),
     { loading: () => <Skeleton /> }
   )
   ```

2. **图片优化**
   - 使用Next.js Image组件
   - WebP格式
   - 懒加载
   - 响应式图片

3. **缓存策略**
   - Static资源: 1年
   - API响应: 5分钟
   - 用户数据: 实时

### 后端优化

1. **数据库查询优化**
   - 合理使用索引
   - 避免N+1查询
   - 使用连接池
   - 查询缓存

2. **Redis缓存**
   ```typescript
   // 缓存课程列表
   const getCourses = async () => {
     const cached = await redis.get('courses:list')
     if (cached) return JSON.parse(cached)
     
     const courses = await db.courses.findAll()
     await redis.set('courses:list', JSON.stringify(courses), 'EX', 300)
     return courses
   }
   ```

3. **API限流**
   ```typescript
   import rateLimit from 'express-rate-limit'
   
   const limiter = rateLimit({
     windowMs: 15 * 60 * 1000, // 15分钟
     max: 100 // 最多100个请求
   })
   
   app.use('/api/', limiter)
   ```

---

## 🔄 CI/CD流程

### GitHub Actions配置

```yaml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm test
      - run: npm run lint

  deploy-frontend:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: vercel/actions@v1
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}

  deploy-backend:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /var/www/mllearning-backend
            git pull origin main
            npm install
            pm2 restart mllearning-api
```

---

## 📚 总结

本技术架构设计涵盖了：
- ✅ 清晰的前后端分离架构
- ✅ 可扩展的微服务设计
- ✅ 安全的代码执行环境
- ✅ 完善的认证授权机制
- ✅ 高性能的缓存策略
- ✅ 全面的监控和日志系统
- ✅ 自动化的CI/CD流程

这个架构能够支撑10,000+用户的并发访问，并为未来的扩展留有充足的空间。

---

**文档维护者**: 技术团队  
**最后更新**: 2025-10-29




